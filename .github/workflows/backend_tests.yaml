name: Backend Tests

# Define quando os testes vão rodar
on:
  push:
    branches: [ "main", "develop", "feat/*" ] # Roda em pushes nessas branches
  pull_request:
    branches: [ "main", "develop" ] # Roda em PRs para essas branches

jobs:
  test:
    runs-on: ubuntu-latest

    # Define a pasta padrão para todos os comandos (IMPORTANTE)
    defaults:
      run:
        working-directory: ./app/backend

    steps:
    # 1. Baixa o teu código
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Instala o Python
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        cache: 'pip' # Faz cache das dependências para ser mais rápido

    # 3. Instala dependências do Sistema (Necessário para o WeasyPrint/PDF)
    # O WeasyPrint precisa do Pango e Cairo para desenhar o PDF
    - name: Install System Dependencies (WeasyPrint)
      run: |
        sudo apt-get update
        sudo apt-get install -y libpango-1.0-0 libpangoft2-1.0-0 libharfbuzz-subset0

    # 4. Instala dependências do Python
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        # Garante que as libs de teste estão instaladas
        pip install pytest httpx pytest-asyncio

    # 5. Roda os Testes
    - name: Run Pytest
      env:
        # Define variáveis de ambiente falsas para o teste não falhar
        SECRET_KEY: "test_secret_key_12345" 
        ALGORITHM: "HS256"
        ACCESS_TOKEN_EXPIRE_MINUTES: 30
      run: |
        pytest -v